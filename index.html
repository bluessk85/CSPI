<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSPI 암호화폐 시즌 고점 예측 지수 대시보드 - 수동 입력</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        .manual-input-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            margin: 20px 0;
            border-radius: 15px;
            color: white;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .input-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .input-card h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.1em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.9);
            box-sizing: border-box;
        }

        .url-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .url-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .calculate-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: transform 0.2s;
        }

        .calculate-btn:hover {
            transform: scale(1.05);
        }

        .result-section {
            background: #f8f9fa;
            padding: 30px;
            margin: 20px 0;
            border-radius: 15px;
            text-align: center;
            color: #333;
        }

        .result-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .result-section h3 {
            color: #333;
            margin: 20px 0 10px 0;
        }

        .cspi-result {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            color: #333;
        }

        .cspi-level {
            font-size: 1.5em;
            margin: 10px 0;
        }

        .cspi-recommendation {
            font-size: 1.2em;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .level-low {
            color: #27ae60;
        }

        .level-medium-low {
            color: #f39c12;
        }

        .level-medium {
            color: #e67e22;
        }

        .level-medium-high {
            color: #e74c3c;
        }

        .level-high {
            color: #c0392b;
        }

        .recommendation-low {
            background: #d5f4e6;
            color: #27ae60;
        }

        .recommendation-medium-low {
            background: #fef9e7;
            color: #f39c12;
        }

        .recommendation-medium {
            background: #fdf2e9;
            color: #e67e22;
        }

        .recommendation-medium-high {
            background: #fadbd8;
            color: #e74c3c;
        }

        .recommendation-high {
            background: #f8d7da;
            color: #c0392b;
        }

        .contributions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .contribution-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .contribution-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .contribution-value {
            font-size: 1.2em;
            color: #3498db;
        }

        /* 사용 방법 섹션 스타일 추가 */
        .instructions-section {
            background: #f8f9fa;
            padding: 30px;
            margin: 20px 0;
            border-radius: 15px;
            color: #333;
        }

        .instructions-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .instructions-section h3 {
            color: #333;
            margin: 20px 0 10px 0;
        }

        .instructions-section ol,
        .instructions-section ul {
            color: #333;
        }

        .instructions-section li {
            color: #333;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="header-title">🚀 CSPI 암호화폐 시즌 고점 예측 지수</h1>
                    <div class="header-subtitle">수동 입력 방식 - 정확한 데이터</div>
                    <div class="header-stats">
                        <div class="stat-item">
                            <span class="stat-label">현재 BTC 가격</span>
                            <span class="stat-value" id="headerBtcPrice">로딩 중...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">CSPI 점수</span>
                            <span class="stat-value cspi-score" id="headerCSPIScore">-/100</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">시장 단계</span>
                            <span class="stat-value market-phase" id="headerMarketPhase">계산 필요</span>
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="current-time">
                        <div class="time-label">현재 시각</div>
                        <div class="time-value" id="currentTime">-</div>
                    </div>
                    <div class="update-info">
                        <div class="update-item">
                            <span class="update-label">마지막 업데이트</span>
                            <span class="update-value" id="lastUpdateTime">-</span>
                        </div>
                        <div class="update-item">
                            <span class="update-label">업데이트 방식</span>
                            <span class="countdown-timer" id="countdownTimer">수동 입력 전용</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Manual Input Section -->
            <section class="manual-input-section">
                <h2>📝 지표 수동 입력</h2>
                <p>각 지표의 현재 값을 확인하고 입력한 후 계산 버튼을 눌러주세요.</p>

                <div class="input-grid">
                    <!-- MVRV Z-Score -->
                    <div class="input-card">
                        <h3>📊 MVRV Z-Score (가중치 30%)</h3>
                        <div class="input-group">
                            <label for="mvrvInput">MVRV Z-Score 값:</label>
                            <input type="number" id="mvrvInput" step="0.01" placeholder="예: 2.61">
                        </div>
                        <a href="https://en.macromicro.me/charts/30335/bitcoin-mvrv-zscore" target="_blank"
                            class="url-link">
                            🔗 MVRV 데이터 확인하기
                        </a>
                    </div>

                    <!-- Fear & Greed Index -->
                    <div class="input-card">
                        <h3>😨 Fear & Greed Index (가중치 5%)</h3>
                        <div class="input-group">
                            <label for="fearGreedInput">Fear & Greed 값 (0-100):</label>
                            <input type="number" id="fearGreedInput" min="0" max="100" placeholder="예: 72">
                        </div>
                        <a href="https://alternative.me/crypto/fear-and-greed-index/" target="_blank" class="url-link">
                            🔗 Fear & Greed 확인하기
                        </a>
                    </div>

                    <!-- Altcoin Season Index -->
                    <div class="input-card">
                        <h3>🌊 알트코인 시즌 인덱스 (가중치 25%)</h3>
                        <div class="input-group">
                            <label for="altseasonInput">알트시즌 인덱스 (0-100):</label>
                            <input type="number" id="altseasonInput" min="0" max="100" placeholder="예: 48">
                        </div>
                        <a href="https://www.blockchaincenter.net/altcoin-season-index/" target="_blank"
                            class="url-link">
                            🔗 알트시즌 인덱스 확인하기
                        </a>
                    </div>

                    <!-- BTC Dominance -->
                    <div class="input-card">
                        <h3>₿ BTC 도미넌스 (가중치 15%)</h3>
                        <div class="input-group">
                            <label for="dominanceInput">BTC 도미넌스 (%):</label>
                            <input type="number" id="dominanceInput" step="0.1" placeholder="예: 63.5">
                        </div>
                        <a href="https://coinmarketcap.com/charts/" target="_blank" class="url-link">
                            🔗 BTC 도미넌스 확인하기
                        </a>
                    </div>

                    <!-- Kimchi Premium -->
                    <div class="input-card">
                        <h3>🌶️ 김치프리미엄 (가중치 20%)</h3>
                        <div class="input-group">
                            <label for="kimchiInput">김치프리미엄 (%):</label>
                            <input type="number" id="kimchiInput" step="0.1" placeholder="예: -0.8">
                        </div>
                        <a href="https://kimpga.com/" target="_blank" class="url-link">
                            🔗 김치프리미엄 확인하기
                        </a>
                    </div>

                    <!-- RSI -->
                    <div class="input-card">
                        <h3>📈 RSI (14일) (가중치 5%)</h3>
                        <div class="input-group">
                            <label for="rsiInput">RSI 값 (0-100):</label>
                            <input type="number" id="rsiInput" min="0" max="100" placeholder="예: 66.5">
                        </div>
                        <a href="https://charts.bitbo.io/monthly-rsi/" target="_blank"
                            class="url-link">
                            🔗 RSI 확인하기 (Bitbo)
                        </a>
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateCSPI()">
                    🧮 CSPI 점수 계산하기
                </button>
            </section>

            <!-- Result Section -->
            <section class="result-section" id="resultSection" style="display: none;">
                <h2>🎯 CSPI 계산 결과</h2>

                <div class="cspi-result" id="cspiResult">-/100</div>
                <div class="cspi-level" id="cspiLevel">-</div>
                <div class="cspi-recommendation" id="cspiRecommendation">-</div>

                <h3>📊 각 지표별 기여도</h3>
                <div class="contributions-grid" id="contributionsGrid">
                    <!-- 기여도 항목들이 여기에 동적으로 추가됩니다 -->
                </div>
            </section>

            <!-- Main CSPI Gauge Section -->
            <section class="cspi-gauge-section">
                <div class="gauge-container">
                    <div class="gauge-header">
                        <h2>🎯 CSPI (Crypto Season Peak Index)</h2>
                        <div class="gauge-subtitle">수동 입력 기반 암호화폐 시즌 고점 예측 지수</div>
                        <div class="real-time-indicator">
                            <span class="pulse-dot"></span>
                            <span>계산 대기 중</span>
                        </div>
                    </div>
                    <div class="gauge-main">
                        <canvas id="cspiGauge" width="300" height="200"></canvas>
                        <div class="gauge-info">
                            <div class="gauge-score">
                                <span class="score-value" id="cspiScoreValue">-</span>
                                <span class="score-total">/100</span>
                            </div>
                            <div class="gauge-status" id="cspiStatus">계산 필요</div>
                            <div class="gauge-description" id="cspiDescription">지표를 입력하고 계산해주세요</div>
                        </div>
                    </div>
                    <div class="gauge-stats">
                        <div class="stat-item">
                            <span class="stat-label">사이클 진행률</span>
                            <span class="stat-value progress-value" id="progressValue">-%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">잔여 상승 여력</span>
                            <span class="stat-value upside-value" id="upsideValue">-포인트</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">위험 수준</span>
                            <span class="stat-value risk-value" id="riskValue">-</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Individual Indicators Grid -->
            <section class="indicators-grid-section">
                <h2>📊 실시간 개별 지표 현황</h2>
                <div class="indicators-grid">
                    <!-- MVRV Z-Score Card -->
                    <div class="indicator-card mvrv-card">
                        <div class="card-header">
                            <h3>MVRV Z-Score</h3>
                            <div class="card-badges">
                                <span class="weight-badge">가중치 30%</span>
                                <span class="api-badge realtime">실시간 API</span>
                            </div>
                        </div>
                        <div class="card-main">
                            <div class="indicator-value" id="mvrvValue">2.8</div>
                            <div class="normalized-score" id="mvrvNormalized">28.0/100</div>
                        </div>
                        <div class="card-status">
                            <div class="status-text" id="mvrvStatus">안전 축적 구간</div>
                            <div class="contribution" id="mvrvContribution">기여도: 8.4</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <span>데이터 출처: MacroMicro.me</span>
                            </div>
                            <div class="detail-item">
                                <span>과거 피크 대비 여유: 72%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Altcoin Season Index Card -->
                    <div class="indicator-card altseason-card">
                        <div class="card-header">
                            <h3>알트코인 시즌 인덱스 ⭐</h3>
                            <div class="card-badges">
                                <span class="weight-badge">가중치 25%</span>
                                <span class="api-badge">계산값</span>
                            </div>
                        </div>
                        <div class="card-main">
                            <div class="indicator-value" id="altseasonValue">48</div>
                            <div class="normalized-score" id="altseasonNormalized">48/100</div>
                        </div>
                        <div class="card-status">
                            <div class="status-text" id="altseasonStatus">Bitcoin Season</div>
                            <div class="contribution" id="altseasonContribution">기여도: 12.0</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <span>알트시즌 임계점(75)까지: 27포인트</span>
                            </div>
                            <div class="detail-item">
                                <span>과거 피크 (2017: 87, 2021: 89)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Kimchi Premium Card -->
                    <div class="indicator-card kimchi-card">
                        <div class="card-header">
                            <h3>김치프리미엄 ⭐</h3>
                            <div class="card-badges">
                                <span class="weight-badge">가중치 20%</span>
                                <span class="api-badge">계산값</span>
                            </div>
                        </div>
                        <div class="card-main">
                            <div class="indicator-value negative" id="kimchiValue">-0.8%</div>
                            <div class="normalized-score" id="kimchiNormalized">48.4/100</div>
                        </div>
                        <div class="card-status">
                            <div class="status-text" id="kimchiStatus">역김치프리미엄</div>
                            <div class="contribution" id="kimchiContribution">기여도: 9.7</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <span>의미: 해외 수요 > 국내 수요</span>
                            </div>
                            <div class="detail-item">
                                <span>과거 피크 (2017: 55%, 2021: 11.86%)</span>
                            </div>
                        </div>
                    </div>

                    <!-- BTC Dominance Card -->
                    <div class="indicator-card dominance-card">
                        <div class="card-header">
                            <h3>BTC 도미넌스</h3>
                            <div class="card-badges">
                                <span class="weight-badge">가중치 15%</span>
                                <span class="api-badge">계산값</span>
                            </div>
                        </div>
                        <div class="card-main">
                            <div class="indicator-value" id="dominanceValue">63.5%</div>
                            <div class="normalized-score" id="dominanceNormalized">36.5/100</div>
                        </div>
                        <div class="card-status">
                            <div class="status-text" id="dominanceStatus">비트코인 강세</div>
                            <div class="contribution" id="dominanceContribution">기여도: 5.5</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <span>알트시즌 기준(35%)까지: 28.5포인트</span>
                            </div>
                            <div class="detail-item">
                                <span>현재 수준: 높음</span>
                            </div>
                        </div>
                    </div>

                    <!-- Fear & Greed Index Card -->
                    <div class="indicator-card feargreed-card">
                        <div class="card-header">
                            <h3>Fear & Greed Index</h3>
                            <div class="card-badges">
                                <span class="weight-badge">가중치 5%</span>
                                <span class="api-badge realtime">실시간 API</span>
                            </div>
                        </div>
                        <div class="card-main">
                            <div class="indicator-value" id="fearGreedValue">72</div>
                            <div class="normalized-score" id="fearGreedNormalized">72/100</div>
                        </div>
                        <div class="card-status">
                            <div class="status-text" id="fearGreedStatus">Greed</div>
                            <div class="contribution" id="fearGreedContribution">기여도: 3.6</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <span>0-100 스케일: 탐욕</span>
                            </div>
                        </div>
                    </div>

                    <!-- RSI Card -->
                    <div class="indicator-card rsi-card">
                        <div class="card-header">
                            <h3>RSI (14일)</h3>
                            <div class="card-badges">
                                <span class="weight-badge">가중치 5%</span>
                                <span class="api-badge">계산값</span>
                            </div>
                        </div>
                        <div class="card-main">
                            <div class="indicator-value" id="rsiValue">66.5</div>
                            <div class="normalized-score" id="rsiNormalized">66.5/100</div>
                        </div>
                        <div class="card-status">
                            <div class="status-text" id="rsiStatus">중립</div>
                            <div class="contribution" id="rsiContribution">기여도: 3.3</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <span>과매수(80+) 임계점까지: 13.5포인트</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Investment Recommendations -->
            <section class="recommendations-section">
                <h2>💡 실시간 투자 권고사항</h2>
                <div class="recommendations-grid">
                    <div class="recommendation-card portfolio-card">
                        <h3>권장 포트폴리오</h3>
                        <div class="portfolio-breakdown">
                            <div class="portfolio-item">
                                <span class="asset-name">BTC</span>
                                <span class="asset-percentage">50%</span>
                            </div>
                            <div class="portfolio-item">
                                <span class="asset-name">ETH</span>
                                <span class="asset-percentage">35%</span>
                            </div>
                            <div class="portfolio-item">
                                <span class="asset-name">ALTS</span>
                                <span class="asset-percentage">15%</span>
                            </div>
                            <div class="portfolio-item">
                                <span class="asset-name">STABLE</span>
                                <span class="asset-percentage">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="recommendation-card timing-card">
                        <h3>타이밍 권고</h3>
                        <div class="timing-text">상승장 초반 - 점진적 매수 지속</div>
                        <div class="risk-assessment">위험 수준: <span class="risk-low">낮음</span></div>
                        <div class="next-update">
                            <span class="update-timer">권고 업데이트: <span id="nextRecommendationUpdate">수동 새로고침
                                    시</span></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Historical Cycles Comparison Chart -->
            <section class="historical-section">
                <h2>📈 과거 사이클 비교 (실시간 업데이트)</h2>
                <div class="chart-container">
                    <canvas id="historicalChart"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #1FB8CD"></div>
                        <span>2017 사이클</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFC185"></div>
                        <span>2021 사이클</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #B4413C"></div>
                        <span>2025 사이클 (현재)</span>
                        <span class="realtime-badge">실시간</span>
                    </div>
                </div>
            </section>

            <!-- Real-time Data Validation Status -->
            <section class="validation-section">
                <h2>🔍 실시간 데이터 검증 시스템</h2>
                <div class="validation-grid">
                    <div class="validation-item">
                        <div class="validation-status connected" id="btcPriceStatus">
                            <span class="status-dot"></span>
                            <span>BTC 가격 데이터</span>
                            <span class="api-source">CoinGecko API</span>
                        </div>
                        <div class="validation-value" id="validationBtcPrice">로딩 중...</div>
                    </div>
                    <div class="validation-item">
                        <div class="validation-status connected" id="cspiStatus">
                            <span class="status-dot"></span>
                            <span>CSPI 지수 데이터</span>
                            <span class="api-source">실시간 계산</span>
                        </div>
                        <div class="validation-value" id="validationCSPI">38.3/100</div>
                    </div>
                    <div class="validation-item">
                        <div class="validation-status connected" id="indicatorsStatus">
                            <span class="status-dot"></span>
                            <span>개별 지표 데이터</span>
                            <span class="api-source">6개 지표 정상</span>
                        </div>
                        <div class="validation-value" id="validationIndicators">실시간 동기화</div>
                    </div>
                    <div class="validation-item">
                        <div class="validation-status connected" id="dataFeedStatus">
                            <span class="status-dot"></span>
                            <span>실시간 데이터 피드</span>
                            <span class="api-source">외부 API 연결</span>
                        </div>
                        <div class="validation-value" id="validationDataFeed">연결됨</div>
                    </div>
                </div>
            </section>

            <!-- Instructions Section -->
            <section class="instructions-section">
                <h2>📋 사용 방법</h2>
                <ol style="font-size: 1.1em; line-height: 1.6;">
                    <li><strong>각 지표 확인:</strong> 제공된 링크를 클릭하여 각 지표의 현재 값을 확인합니다.</li>
                    <li><strong>값 입력:</strong> 확인한 값을 해당 입력 필드에 정확히 입력합니다.</li>
                    <li><strong>계산 실행:</strong> 모든 값을 입력한 후 "CSPI 점수 계산하기" 버튼을 클릭합니다.</li>
                    <li><strong>결과 확인:</strong> 계산된 CSPI 점수와 투자 권고사항을 확인합니다.</li>
                </ol>

                <h3>🎚️ CSPI 점수 해석</h3>
                <ul style="font-size: 1.1em; line-height: 1.6;">
                    <li><strong>0-25:</strong> 🟢 LOW - 적극적 매수 권장</li>
                    <li><strong>25-45:</strong> 🟡 MEDIUM-LOW - 점진적 매수 권장</li>
                    <li><strong>45-65:</strong> 🟠 MEDIUM - 관망 권장</li>
                    <li><strong>65-80:</strong> 🔴 MEDIUM-HIGH - 부분 매도 권장</li>
                    <li><strong>80-100:</strong> 🚨 HIGH - 적극적 매도 권장</li>
                </ul>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>🔄 업데이트 방식: 수동 새로고침 전용 | 📡 데이터 출처: CoinGecko, Alternative.me, MacroMicro API</p>
                <p>⚠️ 본 대시보드는 실제 API에서 실시간 데이터를 가져와 투자 참고용으로 제공되며, 투자 결정은 본인 책임입니다.</p>
                <p>🔬 CSPI 지수는 6가지 기술적 지표를 실시간으로 종합하여 산출됩니다.</p>
                <p>🚀 새로고침 버튼을 누르면 즉시 최신 데이터로 업데이트됩니다!</p>
            </div>
        </div>
    </footer>

    <script>
        // Update current time every second
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('currentTime').textContent = timeString;
        }, 1000);

        // Initialize current time immediately
        const now = new Date();
        const timeString = now.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        document.getElementById('currentTime').textContent = timeString;

        // BTC 가격 가져오기 함수
        async function fetchBTCPrice() {
            try {
                console.log('📡 BTC 가격 데이터 요청 중...');
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.bitcoin) {
                    const price = data.bitcoin.usd;
                    const change24h = data.bitcoin.usd_24h_change || 0;

                    // 가격 포맷팅 (천 단위 콤마)
                    const formattedPrice = `$${price.toLocaleString()}`;

                    // 24시간 변화율 표시
                    const changeSymbol = change24h >= 0 ? '▲' : '▼';
                    const changeColor = change24h >= 0 ? '#27ae60' : '#e74c3c';

                    document.getElementById('headerBtcPrice').innerHTML = `
                        ${formattedPrice} 
                        <span style="color: ${changeColor}; font-size: 0.8em;">
                            ${changeSymbol} ${Math.abs(change24h).toFixed(2)}%
                        </span>
                    `;

                    // validation 섹션도 업데이트
                    document.getElementById('validationBtcPrice').textContent = formattedPrice;

                    console.log(`✅ BTC 가격 업데이트: ${formattedPrice} (${change24h.toFixed(2)}%)`);
                } else {
                    throw new Error('Invalid BTC data format');
                }
            } catch (error) {
                console.error('❌ BTC 가격 데이터 오류:', error);
                document.getElementById('headerBtcPrice').textContent = '가격 로딩 실패';
                document.getElementById('validationBtcPrice').textContent = '가격 로딩 실패';
            }
        }

        // 페이지 로드 시 BTC 가격 가져오기
        fetchBTCPrice();

        // 5분마다 BTC 가격 업데이트
        setInterval(fetchBTCPrice, 5 * 60 * 1000);

        // CSPI 계산 함수
        function calculateCSPI() {
            // 입력값 가져오기
            const mvrv = parseFloat(document.getElementById('mvrvInput').value);
            const fearGreed = parseFloat(document.getElementById('fearGreedInput').value);
            const altseason = parseFloat(document.getElementById('altseasonInput').value);
            const dominance = parseFloat(document.getElementById('dominanceInput').value);
            const kimchi = parseFloat(document.getElementById('kimchiInput').value);
            const rsi = parseFloat(document.getElementById('rsiInput').value);

            // 입력값 검증
            const inputs = [
                { name: 'MVRV Z-Score', value: mvrv, min: -5, max: 15 },
                { name: 'Fear & Greed', value: fearGreed, min: 0, max: 100 },
                { name: '알트시즌 인덱스', value: altseason, min: 0, max: 100 },
                { name: 'BTC 도미넌스', value: dominance, min: 0, max: 100 },
                { name: '김치프리미엄', value: kimchi, min: -20, max: 20 },
                { name: 'RSI', value: rsi, min: 0, max: 100 }
            ];

            let hasError = false;
            let errorMessage = '';

            inputs.forEach(input => {
                if (isNaN(input.value)) {
                    hasError = true;
                    errorMessage += `${input.name} 값을 입력해주세요.\n`;
                } else if (input.value < input.min || input.value > input.max) {
                    hasError = true;
                    errorMessage += `${input.name} 값이 유효 범위(${input.min}~${input.max})를 벗어났습니다.\n`;
                }
            });

            if (hasError) {
                alert(errorMessage);
                return;
            }

            // CSPI 계산 로직 - 과거 데이터 기반 개선
            const weights = {
                mvrv: 0.30,
                altseason: 0.25,
                kimchi: 0.20,
                dominance: 0.15,
                fearGreed: 0.05,
                rsi: 0.05
            };

            // 과거 고점 데이터 기반 정규화 함수들
            function calculateMVRVScore(mvrv) {
                const historicalData = {
                    peak_2017: 7.8,
                    peak_2021: 6.8,
                    buy_zone: 0.5,
                    sell_zone_1: 5.0,
                    extreme_low: -1.5
                };

                if (mvrv <= historicalData.buy_zone) return Math.max(0, (mvrv - historicalData.extreme_low) / (historicalData.buy_zone - historicalData.extreme_low) * 20);
                if (mvrv >= historicalData.peak_2017) return 100;

                // 비선형 스케일링 (고점 근처에서 급격히 증가)
                const position = (mvrv - historicalData.buy_zone) / (historicalData.peak_2017 - historicalData.buy_zone);
                return 20 + Math.pow(position, 1.3) * 80;
            }

            function calculateKimchiScore(kimchi) {
                const historicalData = {
                    peak_2017: 55.0,
                    peak_2021: 11.86,
                    normal_high: 5,
                    extreme_negative: -15
                };

                if (kimchi <= historicalData.extreme_negative) return 0;
                if (kimchi >= historicalData.peak_2017) return 100;

                // S-curve 적용
                const normalized = (kimchi - historicalData.extreme_negative) / (historicalData.peak_2017 - historicalData.extreme_negative);
                return (1 / (1 + Math.exp(-10 * (normalized - 0.5)))) * 100;
            }

            function calculateAltseasonScore(altseason) {
                const historicalData = {
                    peak_2017: 87,
                    peak_2021: 89,
                    bitcoin_threshold: 25,
                    alt_threshold: 75
                };

                if (altseason <= historicalData.bitcoin_threshold) {
                    return altseason * 0.8; // Bitcoin season에서는 낮은 점수
                }
                if (altseason >= historicalData.alt_threshold) {
                    return 60 + (altseason - historicalData.alt_threshold) * 2.67; // 75 이후 가속
                }

                // 중간 구간 선형
                return 20 + (altseason - historicalData.bitcoin_threshold) * 0.8;
            }

            function calculateDominanceScore(dominance) {
                const historicalData = {
                    alt_season_threshold: 35,
                    bitcoin_season_threshold: 70,
                    extreme_high: 80
                };

                if (dominance >= historicalData.extreme_high) return 0;
                if (dominance <= historicalData.alt_season_threshold) return 100;

                // 역비례 관계 (도미넌스 높을수록 CSPI 낮음)
                return Math.max(0, 100 - ((dominance - historicalData.alt_season_threshold) / (historicalData.extreme_high - historicalData.alt_season_threshold)) * 100);
            }

            function calculateFearGreedScore(fearGreed) {
                // Fear & Greed는 역설적 지표 (극단적일 때 반대 신호)
                if (fearGreed <= 10) return 20; // Extreme Fear = 매수 기회
                if (fearGreed >= 90) return 90; // Extreme Greed = 위험

                // 50 근처에서 중립, 양 극단으로 갈수록 위험도 증가
                const deviation = Math.abs(fearGreed - 50);
                return 50 + deviation * 0.8;
            }

            function calculateRSIScore(rsi) {
                // RSI 과매수/과매도 구간 고려
                if (rsi <= 30) return 20; // 과매도 = 매수 기회
                if (rsi >= 70) return 80; // 과매수 = 위험

                return rsi; // 중간 구간은 그대로
            }

            // 개선된 정규화 적용
            const normalizedMvrv = calculateMVRVScore(mvrv);
            const normalizedFearGreed = calculateFearGreedScore(fearGreed);
            const normalizedAltseason = calculateAltseasonScore(altseason);
            const normalizedDominance = calculateDominanceScore(dominance);
            const normalizedKimchi = calculateKimchiScore(kimchi);
            const normalizedRsi = calculateRSIScore(rsi);

            // 기여도 계산
            const contributions = {
                mvrv: normalizedMvrv * weights.mvrv,
                altseason: normalizedAltseason * weights.altseason,
                kimchi: normalizedKimchi * weights.kimchi,
                dominance: normalizedDominance * weights.dominance,
                fearGreed: normalizedFearGreed * weights.fearGreed,
                rsi: normalizedRsi * weights.rsi
            };

            // 총 CSPI 점수
            const cspiScore = Object.values(contributions).reduce((sum, contrib) => sum + contrib, 0);

            // 결과 표시
            displayResults(cspiScore, contributions, {
                mvrv: normalizedMvrv,
                fearGreed: normalizedFearGreed,
                altseason: normalizedAltseason,
                dominance: normalizedDominance,
                kimchi: normalizedKimchi,
                rsi: normalizedRsi
            });

            // 기존 UI 업데이트
            updateExistingUI(cspiScore, {
                mvrv: mvrv,
                fearGreed: fearGreed,
                altseason: altseason,
                dominance: dominance,
                kimchi: kimchi,
                rsi: rsi
            }, contributions);
        }

        function displayResults(cspiScore, contributions, normalized) {
            // CSPI 점수 표시
            document.getElementById('cspiResult').textContent = `${cspiScore.toFixed(1)}/100`;

            // 레벨 및 권고사항 결정
            let level, recommendation, levelClass, recommendationClass;

            if (cspiScore < 25) {
                level = '🟢 LOW';
                recommendation = '적극적 매수 권장';
                levelClass = 'level-low';
                recommendationClass = 'recommendation-low';
            } else if (cspiScore < 45) {
                level = '🟡 MEDIUM-LOW';
                recommendation = '점진적 매수 권장';
                levelClass = 'level-medium-low';
                recommendationClass = 'recommendation-medium-low';
            } else if (cspiScore < 65) {
                level = '🟠 MEDIUM';
                recommendation = '관망 권장';
                levelClass = 'level-medium';
                recommendationClass = 'recommendation-medium';
            } else if (cspiScore < 80) {
                level = '🔴 MEDIUM-HIGH';
                recommendation = '부분 매도 권장';
                levelClass = 'level-medium-high';
                recommendationClass = 'recommendation-medium-high';
            } else {
                level = '🚨 HIGH';
                recommendation = '적극적 매도 권장';
                levelClass = 'level-high';
                recommendationClass = 'recommendation-high';
            }

            document.getElementById('cspiLevel').textContent = level;
            document.getElementById('cspiLevel').className = `cspi-level ${levelClass}`;

            document.getElementById('cspiRecommendation').textContent = recommendation;
            document.getElementById('cspiRecommendation').className = `cspi-recommendation ${recommendationClass}`;

            // 헤더 업데이트
            document.getElementById('headerCSPIScore').textContent = `${cspiScore.toFixed(1)}/100`;
            document.getElementById('headerMarketPhase').textContent = level;

            // 기여도 표시
            const contributionsGrid = document.getElementById('contributionsGrid');
            contributionsGrid.innerHTML = '';

            const contributionLabels = {
                mvrv: 'MVRV Z-Score',
                altseason: '알트시즌 인덱스',
                kimchi: '김치프리미엄',
                dominance: 'BTC 도미넌스',
                fearGreed: 'Fear & Greed',
                rsi: 'RSI'
            };

            Object.entries(contributions).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'contribution-item';
                item.innerHTML = `
                    <div class="contribution-name">${contributionLabels[key]}</div>
                    <div class="contribution-value">${value.toFixed(2)}점</div>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        정규화: ${normalized[key].toFixed(1)}/100
                    </div>
                `;
                contributionsGrid.appendChild(item);
            });

            // 결과 섹션 표시
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function updateExistingUI(cspiScore, rawValues, contributions) {
            // 메인 게이지 업데이트
            document.getElementById('cspiScoreValue').textContent = cspiScore.toFixed(1);

            // 상태 업데이트
            let status, description, riskLevel;
            if (cspiScore < 25) {
                status = '🟢 LOW';
                description = '적극적 매수 권장';
                riskLevel = '낮음';
            } else if (cspiScore < 45) {
                status = '🟡 MEDIUM-LOW';
                description = '점진적 매수 권장';
                riskLevel = '낮음';
            } else if (cspiScore < 65) {
                status = '🟠 MEDIUM';
                description = '관망 권장';
                riskLevel = '보통';
            } else if (cspiScore < 80) {
                status = '🔴 MEDIUM-HIGH';
                description = '부분 매도 권장';
                riskLevel = '높음';
            } else {
                status = '🚨 HIGH';
                description = '적극적 매도 권장';
                riskLevel = '매우 높음';
            }

            document.getElementById('cspiStatus').textContent = status;
            document.getElementById('cspiDescription').textContent = description;
            document.getElementById('progressValue').textContent = `${cspiScore.toFixed(1)}%`;
            document.getElementById('upsideValue').textContent = `${(100 - cspiScore).toFixed(1)}포인트`;
            document.getElementById('riskValue').textContent = riskLevel;

            // 개별 지표 카드 업데이트
            document.getElementById('mvrvValue').textContent = rawValues.mvrv.toFixed(2);
            document.getElementById('mvrvNormalized').textContent = `${((rawValues.mvrv / 12.0) * 100).toFixed(1)}/100`;
            document.getElementById('mvrvContribution').textContent = `기여도: ${contributions.mvrv.toFixed(1)}`;

            document.getElementById('altseasonValue').textContent = rawValues.altseason;
            document.getElementById('altseasonNormalized').textContent = `${rawValues.altseason}/100`;
            document.getElementById('altseasonContribution').textContent = `기여도: ${contributions.altseason.toFixed(1)}`;

            document.getElementById('kimchiValue').textContent = `${rawValues.kimchi}%`;
            document.getElementById('kimchiNormalized').textContent = `${(((rawValues.kimchi + 20) / 40) * 100).toFixed(1)}/100`;
            document.getElementById('kimchiContribution').textContent = `기여도: ${contributions.kimchi.toFixed(1)}`;

            document.getElementById('dominanceValue').textContent = `${rawValues.dominance}%`;
            document.getElementById('dominanceNormalized').textContent = `${(((70 - rawValues.dominance) / 35) * 100).toFixed(1)}/100`;
            document.getElementById('dominanceContribution').textContent = `기여도: ${contributions.dominance.toFixed(1)}`;

            document.getElementById('fearGreedValue').textContent = rawValues.fearGreed;
            document.getElementById('fearGreedNormalized').textContent = `${rawValues.fearGreed}/100`;
            document.getElementById('fearGreedContribution').textContent = `기여도: ${contributions.fearGreed.toFixed(1)}`;

            document.getElementById('rsiValue').textContent = rawValues.rsi.toFixed(1);
            document.getElementById('rsiNormalized').textContent = `${rawValues.rsi.toFixed(1)}/100`;
            document.getElementById('rsiContribution').textContent = `기여도: ${contributions.rsi.toFixed(1)}`;

            // 개별 지표 상태 텍스트 업데이트
            document.getElementById('mvrvStatus').textContent = rawValues.mvrv < 5 ? "안전 축적 구간" : "주의 구간";
            document.getElementById('altseasonStatus').textContent = rawValues.altseason > 75 ? "Altcoin Season" : "Bitcoin Season";
            document.getElementById('kimchiStatus').textContent = rawValues.kimchi < 0 ? "역김치프리미엄" : "김치프리미엄";
            document.getElementById('dominanceStatus').textContent = rawValues.dominance > 60 ? "비트코인 강세" : "알트코인 강세";

            // Fear & Greed 상태
            let fearGreedStatus;
            if (rawValues.fearGreed <= 25) fearGreedStatus = "Extreme Fear";
            else if (rawValues.fearGreed <= 45) fearGreedStatus = "Fear";
            else if (rawValues.fearGreed <= 55) fearGreedStatus = "Neutral";
            else if (rawValues.fearGreed <= 75) fearGreedStatus = "Greed";
            else fearGreedStatus = "Extreme Greed";
            document.getElementById('fearGreedStatus').textContent = fearGreedStatus;

            // RSI 상태
            let rsiStatus;
            if (rawValues.rsi > 70) rsiStatus = "과매수";
            else if (rawValues.rsi < 30) rsiStatus = "과매도";
            else rsiStatus = "중립";
            document.getElementById('rsiStatus').textContent = rsiStatus;

            // 과거 사이클 비교 차트 업데이트
            updateHistoricalChart(cspiScore);
            console.log(`📊 차트 업데이트 호출됨 - CSPI: ${cspiScore}`);
        }

        // 현재 사이클 데이터 생성 함수
        function generateCurrentCycleData(currentCSPI) {
            const baseData = [15, 20, 25, 32]; // 초기 4개 포인트
            const totalPoints = 11; // 0%부터 100%까지 11개 포인트

            // 현재 CSPI 점수에 따라 위치 결정
            let currentIndex = Math.min(Math.floor(currentCSPI / 10), 10);
            if (currentIndex < 4) currentIndex = 4; // 최소 40% 위치

            const result = [...baseData];

            // 현재 포인트까지 데이터 채우기
            for (let i = 4; i <= currentIndex && i < totalPoints; i++) {
                if (i === currentIndex) {
                    result[i] = currentCSPI;
                } else {
                    // 선형 보간으로 중간값 계산
                    const progress = (i - 3) / (currentIndex - 3);
                    result[i] = 32 + (currentCSPI - 32) * progress;
                }
            }

            // 현재 포인트 이후는 예측 곡선 (옵션)
            for (let i = currentIndex + 1; i < totalPoints; i++) {
                // 과거 패턴 기반 예측 (2017, 2021 평균)
                const avgPattern = [20, 25, 30, 35, 45, 55, 70, 85, 95, 92, 88];
                const scaleFactor = currentCSPI / avgPattern[currentIndex];
                result[i] = avgPattern[i] * scaleFactor;
            }

            return result;
        }

        function getCurrentCycleIndex(currentCSPI) {
            let index = Math.min(Math.floor(currentCSPI / 10), 10);
            return Math.max(index, 4); // 최소 40% 위치
        }

        // 과거 사이클 비교 차트 업데이트 함수 (새로 작성)
        function updateHistoricalChart(currentCSPI) {
            console.log(`🔄 차트 업데이트 시작 - CSPI: ${currentCSPI}`);

            const canvas = document.getElementById('historicalChart');
            if (!canvas) {
                console.error('❌ historicalChart 캔버스를 찾을 수 없습니다');
                return;
            }

            // Chart.js 로드 확인
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js가 로드되지 않았습니다');
                return;
            }

            // 캔버스 초기화 (크기 재설정으로 강제 정리)
            const parent = canvas.parentNode;
            const newCanvas = canvas.cloneNode(true);
            parent.replaceChild(newCanvas, canvas);
            console.log('🔄 캔버스 초기화 완료');

            // 기존 차트가 있으면 완전히 제거
            if (window.historicalChart) {
                try {
                    window.historicalChart.destroy();
                    window.historicalChart = null;
                    console.log('�️ 기존  차트 완전히 제거됨');
                } catch (e) {
                    console.warn('⚠️ 차트 제거 중 오류:', e);
                    window.historicalChart = null;
                }
            }

            // Chart.js 인스턴스 강제 정리
            Chart.getChart(canvas)?.destroy();
            console.log('📊 새 차트 생성 중...');

            // 현재 사이클 데이터 생성 (간단한 방식)
            const current2025Data = [15, 20, 25, 32];

            // CSPI 점수에 따라 현재 위치에 점 추가
            if (currentCSPI >= 35) current2025Data.push(currentCSPI);
            else current2025Data.push(35, currentCSPI);

            // 나머지는 null로 채우기
            while (current2025Data.length < 11) {
                current2025Data.push(null);
            }

            console.log('📊 2025 사이클 데이터:', current2025Data);

            const chartData = {
                labels: ['0%', '10%', '20%', '30%', '40%', '50%', '60%', '70%', '80%', '90%', '100%'],
                datasets: [
                    {
                        label: '2017 사이클',
                        data: [20, 25, 30, 35, 45, 55, 70, 85, 95, 92, 88],
                        borderColor: '#1FB8CD',
                        backgroundColor: 'rgba(31, 184, 205, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        fill: false
                    },
                    {
                        label: '2021 사이클',
                        data: [18, 22, 28, 38, 48, 58, 68, 78, 92, 89, 85],
                        borderColor: '#FFC185',
                        backgroundColor: 'rgba(255, 193, 133, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        fill: false
                    },
                    {
                        label: '2025 사이클 (현재)',
                        data: current2025Data,
                        borderColor: '#B4413C',
                        backgroundColor: 'rgba(180, 65, 60, 0.1)',
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        fill: false,
                        borderDash: [5, 5]
                    }
                ]
            };

            try {
                const newCanvas = document.getElementById('historicalChart');
                const ctx = newCanvas.getContext('2d');
                if (!ctx) {
                    console.error('❌ 캔버스 컨텍스트를 가져올 수 없습니다');
                    return;
                }

                window.historicalChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(22, 27, 34, 0.95)',
                                titleColor: '#f0f6fc',
                                bodyColor: '#f0f6fc',
                                borderColor: '#58a6ff',
                                borderWidth: 1,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null && context.parsed.y !== undefined) {
                                            label += context.parsed.y.toFixed(1) + ' CSPI';

                                            if (context.dataset.label.includes('2025')) {
                                                label += ' (현재)';
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#30363d',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#8b949e'
                                },
                                title: {
                                    display: true,
                                    text: '사이클 진행률',
                                    color: '#8b949e',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: '#30363d',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#8b949e',
                                    callback: function (value) {
                                        return value.toFixed(0);
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'CSPI 점수',
                                    color: '#8b949e',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });

                console.log('✅ 차트 생성 완료');

            } catch (error) {
                console.error('❌ 차트 생성 실패:', error);
            }
        }
    </script>
    <script src="crypto-data.js"></script>
    <script src="main.js"></script>
</body>

</html>